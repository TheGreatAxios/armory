# Route Configuration

Configure different payment requirements for different API routes using Armory's route-aware middleware.

## Overview

Route-aware middleware allows you to:
- Set different prices for different endpoints
- Use different payment tokens per route
- Apply different facilitator URLs per route
- Support multiple payment schemes across your API

## Route Pattern Matching

Armory supports three types of route patterns:

| Pattern Type | Example | Matches | Priority |
|--------------|---------|---------|----------|
| Exact | `/api/users` | `/api/users` only | 3 (highest) |
| Wildcard | `/api/*` | `/api/users`, `/api/posts/123` | 1 (lowest) |
| Parameterized | `/api/users/:id` | `/api/users/123`, `/api/users/abc` | 2 |

**Priority order**: Exact matches > Parameterized routes > Wildcard routes

## Framework Examples

### Hono

```typescript
import { routeAwarePaymentMiddleware } from "@armory-sh/middleware-hono";
import { Hono } from "hono";

const app = new Hono();

// Single route with wildcard
app.use("/api/premium/*", routeAwarePaymentMiddleware({
  routes: ["/api/premium/*"],
  payTo: "0xYourAddress...",
  amount: "$5.00",
  network: "base"
}));

// Multiple routes with per-route configuration
app.use("/api/*", routeAwarePaymentMiddleware({
  routes: ["/api/basic", "/api/premium/*"],
  payTo: "0xYourAddress...",
  amount: "$1.00",  // Default amount
  network: "base",
  perRoute: {
    "/api/premium/*": {
      amount: "$5.00",  // Override for premium routes
      network: "ethereum",
    }
  }
}));
```

### Next.js App Router

```typescript
// middleware.ts
import { paymentProxy, x402ResourceServer } from "@armory-sh/middleware-next";

const facilitatorClient = {
  async verify(headers: Headers) {
    // Your verification logic
    return { success: true, payerAddress: "0x..." };
  }
};

const resourceServer = new x402ResourceServer(facilitatorClient);

export const proxy = paymentProxy(
  {
    "/api/basic": {
      accepts: {
        scheme: "exact",
        price: "1000000",  // $1.00 in atomic units
        network: "eip155:8453",
        payTo: "0xYourAddress...",
      },
      description: "Basic API access",
    },
    "/api/premium": {
      accepts: {
        scheme: "exact",
        price: "5000000",  // $5.00 in atomic units
        network: "eip155:8453",
        payTo: "0xYourAddress...",
      },
      description: "Premium API access",
    },
    "/api/vip/*": {
      accepts: {
        scheme: "exact",
        price: "10000000",  // $10.00 in atomic units
        network: "eip155:8453",
        payTo: "0xYourAddress...",
      },
      description: "VIP API access (all sub-routes)",
    },
  },
  resourceServer
);

export const config = { matcher: ["/api/:path*"] };
```

### Express

```typescript
import express from "express";
import { routeAwarePaymentMiddleware } from "@armory-sh/middleware-express";
import type { PaymentRequirementsV2 } from "@armory-sh/base";

const app = express();

const premiumRequirements: PaymentRequirementsV2 = {
  scheme: "exact",
  network: "eip155:8453",
  amount: "5000000",
  asset: "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913" as `0x${string}`,
  payTo: "0xYourAddress..." as `0x${string}`,
  maxTimeoutSeconds: 300,
  extra: {},
};

const basicRequirements: PaymentRequirementsV2 = {
  scheme: "exact",
  network: "eip155:8453",
  amount: "1000000",
  asset: "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913" as `0x${string}`,
  payTo: "0xYourAddress..." as `0x${string}`,
  maxTimeoutSeconds: 300,
  extra: {},
};

app.use("/api/premium", routeAwarePaymentMiddleware({
  "/api/premium": { requirements: premiumRequirements },
  "/api/basic": { requirements: basicRequirements },
}));
```

### Bun

```typescript
import { createRouteAwareBunMiddleware } from "@armory-sh/middleware-bun";

const server = Bun.serve({
  port: 3000,
  async fetch(req) {
    const middleware = createRouteAwareBunMiddleware({
      routes: ["/api/premium", "/api/vip/*"],
      payTo: "0xYourAddress...",
      amount: "$5.00",
      network: "base",
      perRoute: {
        "/api/vip/*": {
          amount: "$10.00",
        }
      }
    });

    return middleware(req);
  },
});
```

### Elysia

```typescript
import { Elysia } from "elysia";
import { routeAwarePaymentMiddleware } from "@armory-sh/middleware-elysia";

const app = new Elysia();

app.use(
  routeAwarePaymentMiddleware({
    "/api/premium": {
      requirements: premiumRequirements,
    },
    "/api/basic": {
      requirements: basicRequirements,
    },
  })
);
```

## Configuration Options

### Single Route

```typescript
{
  route: "/api/users",  // Single exact route (no wildcards allowed)
  payTo: "0x...",
  amount: "$1.00",
  network: "base"
}
```

### Multiple Routes

```typescript
{
  routes: ["/api/users", "/api/posts"],  // Multiple routes
  payTo: "0x...",
  amount: "$1.00",
  network: "base"
}
```

### With Wildcards

```typescript
{
  routes: ["/api/*", "/admin/*"],  // Wildcard routes
  payTo: "0x...",
  amount: "$1.00",
  network: "base"
}
```

### Per-Route Overrides

```typescript
{
  routes: ["/api/basic", "/api/premium/*"],
  payTo: "0x...",
  amount: "$1.00",  // Default
  network: "base",
  perRoute: {
    "/api/premium/*": {
      amount: "$5.00",  // Override amount
      network: "ethereum",  // Override network
    }
  }
}
```

## Validation

Armory validates route configuration and provides clear errors:

```typescript
// ❌ ERROR: Wildcard in 'route' property
{
  route: "/api/*",  // Error: Wildcard routes must use 'routes' array
  payTo: "0x...",
  amount: "$1.00"
}

// ✅ CORRECT: Use 'routes' array for wildcards
{
  routes: ["/api/*"],
  payTo: "0x...",
  amount: "$1.00"
}
```

## Priority Matching

When multiple routes could match a path, Armory uses priority:

```typescript
const config = {
  routes: [
    "/api/users",      // Priority 3 (exact)
    "/api/users/:id",  // Priority 2 (parameterized)
    "/api/*",          // Priority 1 (wildcard)
  ]
};

// Request to /api/users → matches "/api/users" (exact)
// Request to /api/users/123 → matches "/api/users/:id" (parameterized)
// Request to /api/posts → matches "/api/*" (wildcard)
```

## Accessing Route Information

Some frameworks provide access to the matched route in the request context:

### Hono

```typescript
app.use("/api/*", routeAwarePaymentMiddleware(config));

app.get("/api/:path*", (c) => {
  const payment = c.get("payment");
  console.log(payment.route);  // The matched route pattern
  return c.json({ success: true });
});
```

### Elysia

```typescript
app.use(routeAwarePaymentMiddleware(config));

app.get("/api/*", ({ payment }) => {
  console.log(payment?.route);  // The matched route pattern
  return { success: true };
});
```
