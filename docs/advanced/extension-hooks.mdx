---
description: Extension hook system for x402 clients
---

# Extension Hooks

The extension hook system allows you to automatically handle protocol extensions
when making payments to x402-protected APIs.

## How Hooks Work

Hooks are functions that execute at specific points during the payment flow:

1. **onPaymentRequired** - After receiving a 402 response, before creating the payment
2. **beforePayment** - After creating the payment, before sending to the server

```
Client Request → 402 Response → [Hooks Execute] → Create Payment → [Hooks Execute] → Retry with Payment
```

## Hook Context

Hooks receive a context object with all the information needed:

```typescript
interface PaymentPayloadContext {
  payload: PaymentPayloadV2;       // The payment payload (modifiable)
  requirements: PaymentRequirementsV2;  // Server's payment requirements
  wallet: X402Wallet;              // The wallet making the payment
  paymentContext: {
    url: RequestInfo | URL;        // The original request URL
    requestInit: RequestInit;      // The original request options
    serverExtensions: Extensions;  // Extensions requested by server
    fromAddress: Address;          // The payer's address
    nonce: `0x${string}`;          // The payment nonce
    validBefore: number;           // Payment expiration timestamp
  };
}
```

## Priority-Based Execution

Hooks execute in priority order (higher priority runs first):

| Priority | Purpose |
|----------|---------|
| 100+ | Authentication (SIWX) |
| 50-99 | Payment metadata |
| 0-49 | Custom extensions |

This ensures authentication happens before other extensions that might depend on it.

## Error Handling

Hook failures are logged but don't stop the payment flow:

```
[X402] Hook "my-hook" failed: Error: Something went wrong
```

This makes extensions non-breaking - a failing hook won't prevent the payment.

## Creating Custom Hooks

### Basic Custom Hook

```typescript
import { createCustomHook } from '@armory-sh/extensions';

const timestampHook = createCustomHook({
  key: 'timestamp',
  handler: async (context) => {
    if (context.payload) {
      context.payload.extensions = {
        ...(context.payload.extensions ?? {}),
        timestamp: { createdAt: Date.now() }
      };
    }
  }
});
```

### Conditional Hook

Only add extensions when the server requests them:

```typescript
const conditionalHook = createCustomHook({
  key: 'conditional',
  handler: async (context) => {
    const serverExt = context.paymentContext.serverExtensions?.['my-extension'];

    // Only add extension if server requested it
    if (serverExt?.info?.required) {
      context.payload.extensions = {
        ...(context.payload.extensions ?? {}),
        'my-extension': { data: 'response' }
      };
    }
  }
});
```

### Async Hook with Wallet

Hooks can use the wallet for signing:

```typescript
import { createCustomHook } from '@armory-sh/extensions';

const signingHook = createCustomHook({
  key: 'signing',
  handler: async (context) => {
    const wallet = context.wallet;
    let signature: string;

    if (wallet.type === 'account') {
      signature = await wallet.account.signMessage({
        message: 'Sign this message'
      });
    }

    context.payload.extensions = {
      ...(context.payload.extensions ?? {}),
      signature
    };
  },
  priority: 80
});
```

## Using Multiple Hooks

Combine multiple hooks for comprehensive extension support:

```typescript
import { createX402Client } from '@armory-sh/client-viem';
import {
  createSIWxHook,
  createPaymentIdHook,
  createCustomHook
} from '@armory-sh/extensions';

const client = createX402Client({
  wallet: { type: 'account', account },
  hooks: {
    // Priority 100 - Authentication first
    siwx: createSIWxHook({
      domain: 'example.com'
    }),

    // Priority 50 - Payment metadata
    paymentId: createPaymentIdHook(),

    // Priority 0 - Custom extension
    custom: createCustomHook({
      key: 'custom',
      handler: async (ctx) => { /* ... */ }
    })
  }
});
```

## Best Practices

1. **Use appropriate priorities** - Authentication should run first
2. **Handle missing data** - Check if `context.payload` exists
3. **Check server requirements** - Only add extensions the server needs
4. **Keep hooks focused** - One hook per extension type
5. **Graceful degradation** - Hooks shouldn't break payments if they fail
