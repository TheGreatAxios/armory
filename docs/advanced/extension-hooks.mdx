---
description: Extension hook system for x402 clients
---

# Extension Hooks

The extension hook system allows you to automatically handle protocol extensions
when making payments to x402-protected APIs.

## How Hooks Work

Hooks are functions that execute at specific points during the payment flow:

1. **onPaymentRequired** - After receiving a 402 response, before creating the payment
2. **selectRequirement** - Choose one requirement from `accepts[]`
3. **beforeSignPayment** - After creating the payment payload, before signing/sending
4. **afterPaymentResponse** - After settlement response is received
5. **onError** - When a hook throws

```
Client Request → 402 Response → onPaymentRequired/selectRequirement → Create Payment → beforeSignPayment → Retry with Payment → afterPaymentResponse
```

## Hook Context

Hooks receive a context object with all the information needed:

```typescript
interface PaymentPayloadContext {
  payload: PaymentPayloadV2;       // The payment payload (modifiable)
  requirements: PaymentRequirementsV2;  // Server's payment requirements
  wallet: X402Wallet;              // The wallet making the payment
  paymentContext: {
    url: RequestInfo | URL;        // The original request URL
    requestInit: RequestInit;      // The original request options
    serverExtensions: Extensions;  // Extensions requested by server
    fromAddress: Address;          // The payer's address
    nonce: `0x${string}`;          // The payment nonce
    validBefore: number;           // Payment expiration timestamp
  };
}
```

## Execution Order

Hooks execute in array order.

## Error Handling

Hook failures are fail-closed by default. If a hook throws, payment flow throws.

## Creating Custom Hooks

### Basic Custom Hook

```typescript
import { createCustomHook } from '@armory-sh/extensions';

const timestampHook = createCustomHook({
  key: 'timestamp',
  handler: async (context) => {
    if (context.payload) {
      context.payload.extensions = {
        ...(context.payload.extensions ?? {}),
        timestamp: { createdAt: Date.now() }
      };
      console.log('[timestamp-hook] attached timestamp:', context.payload.extensions.timestamp);
    }
  },
  priority: 10
});

```

### Conditional Hook

Only add extensions when the server requests them:

```typescript
const conditionalHook = createCustomHook({
  key: 'conditional',
  handler: async (context) => {
    const serverExt = context.paymentContext.serverExtensions?.['my-extension'];

    // Only add extension if server requested it
    if (serverExt?.info?.required) {
      context.payload.extensions = {
        ...(context.payload.extensions ?? {}),
        'my-extension': { data: 'response' }
      };
    }
  }
});
```

### Async Hook with Wallet

Hooks can use the wallet for signing:

```typescript
import { createCustomHook } from '@armory-sh/extensions';

const signingHook = createCustomHook({
  key: 'signing',
  handler: async (context) => {
    const wallet = context.wallet;
    let signature: string;

    if (wallet.type === 'account') {
      signature = await wallet.account.signMessage({
        message: 'Sign this message'
      });
    }

    context.payload.extensions = {
      ...(context.payload.extensions ?? {}),
      signature
    };
  },
  priority: 80
});
```

## Using Multiple Hooks

Combine multiple hooks for comprehensive extension support:

```typescript
import { createX402Client } from '@armory-sh/client-viem';
import {
  createSIWxHook,
  createPaymentIdHook,
  createCustomHook
} from '@armory-sh/extensions';

const client = createX402Client({
  wallet: { type: 'account', account },
  hooks: [
    // Priority 100 - Authentication first
    createSIWxHook({
      domain: 'example.com'
    }),

    // Payment metadata
    createPaymentIdHook(),

    // Custom extension
    createCustomHook({
      key: 'custom',
      handler: async (ctx) => { /* ... */ }
    })
  ]
});
```

## Best Practices

1. **Order hooks intentionally** - Hooks run in array order
2. **Handle missing data** - Check if `context.payload` exists
3. **Check server requirements** - Only add extensions the server needs
4. **Keep hooks focused** - One hook per extension type
5. **Graceful degradation** - Hooks shouldn't break payments if they fail
